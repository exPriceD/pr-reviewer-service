# Тестовое задание для стажёра Backend (осенняя волна 2025)

Сервис для автоматического назначения ревьюверов на Pull Request'ы внутри команд. Сервис управляет командами, пользователями и автоматически назначает до двух активных ревьюверов при создании PR из команды автора.

## Требования

- Go 1.24.5 или выше
- PostgreSQL 18 или выше
- Docker и Docker Compose (для запуска через Docker)
- Make (опционально, для удобства использования команд)

## Быстрый старт

### Запуск через Docker Compose

Самый простой способ запустить сервис со всеми зависимостями.

#### С использованием Makefile:

```bash
make docker-up
```

#### Или напрямую через Docker Compose:

```bash
cd deployments
docker compose up -d
```

Сервис будет доступен на порту 8080. База данных автоматически создается и миграции применяются при старте контейнера.

Для остановки:

```bash
make docker-down
# или
cd deployments && docker compose down
```

Для полной очистки (включая данные):

```bash
make docker-clean
# или
cd deployments && docker compose down -v --remove-orphans
```

### Локальный запуск

Для запуска на локальной машине:

1. Убедитесь, что PostgreSQL запущен и доступен

2. Создайте базу данных:

```bash
createdb pr_reviewer
```

3. Примените миграции. Миграции находятся в папке `migrations/` и используют библиотеку `migrate`. Пример:

```bash
migrate -path migrations -database "postgres://user:password@localhost/pr_reviewer?sslmode=disable" up
```

4. Создайте файл конфигурации `configs/development.yaml` или используйте переменные окружения (см. раздел Конфигурация)

5. Запустите сервис:

```bash
make run
```

Или соберите бинарный файл:

```bash
make build
./bin/pr-reviewer-service
```

## Конфигурация

Сервис использует YAML файлы конфигурации из папки `configs/`. По умолчанию загружается `configs/development.yaml`. Для выбора другого конфига используется переменная окружения `CONFIG_FILE`.

Например, для использования `configs/docker.yaml`:

```bash
CONFIG_FILE=docker make run
```

Все параметры конфигурации могут быть переопределены через переменные окружения:

- `DB_HOST` - хост базы данных (по умолчанию localhost)
- `DB_PORT` - порт базы данных (по умолчанию 5432)
- `DB_USER` - пользователь базы данных (по умолчанию postgres)
- `DB_PASSWORD` - пароль базы данных (по умолчанию postgres)
- `DB_NAME` - имя базы данных (по умолчанию pr_reviewer)
- `SERVER_HOST` - хост для HTTP сервера (по умолчанию localhost)
- `SERVER_PORT` - порт для HTTP сервера (по умолчанию 8080)

Пример запуска с переменными окружения:

```bash
DB_HOST=localhost DB_PORT=5432 DB_USER=postgres DB_PASSWORD=secret SERVER_PORT=8080 make run
```

## Доступные команды

### Тестирование

```bash
make test              # Запустить все unit тесты
make test-v            # Тесты с подробным выводом
make test-integration  # Запустить интеграционные тесты (требуется Docker)
make test-e2e          # Запустить E2E тесты (требуется Docker)
make coverage          # Показать покрытие тестами
```

### Качество кода

```bash
make fmt           # Форматировать код
make fmt-check     # Проверить форматирование
make vet           # Запустить go vet
make lint          # Запустить golangci-lint
make lint-install  # Установить golangci-lint
make check         # Все проверки (fmt, vet, lint, test)
```

### Сборка и запуск

```bash
make build   # Собрать бинарный файл
make run     # Запустить приложение
make clean   # Удалить сгенерированные файлы
```

### Зависимости

```bash
make deps     # Установить зависимости
make mod-tidy # Очистить go.mod
make mocks    # Генерация моков для тестов
```

### CI/CD

```bash
make ci         # CI pipeline (fmt, vet, lint, test, coverage)
make pre-commit # Проверки перед коммитом (fmt, vet, test)
```

### Нагрузочное тестирование

```bash
make k6-install  # Проверить установку K6
make load-test   # Запустить нагрузочное тестирование
```

Перед запуском нагрузочного тестирования убедитесь, что сервер запущен на http://localhost:8080. Или укажите другой адрес.

### Docker команды

```bash
make docker-up       # Запустить Docker Compose
make docker-down     # Остановить Docker Compose
make docker-restart  # Перезапустить Docker Compose
make docker-build    # Пересобрать образы
make docker-logs     # Показать логи контейнеров
make docker-ps       # Показать статус контейнеров
make docker-clean    # Остановить и удалить все (включая volumes)
```

## API

Сервис предоставляет REST API для работы с командами, пользователями и Pull Request'ами. Полная спецификация API находится в файле `api/openapi.yml`.

Основные эндпоинты:

- `POST /team/add` - Создать команду с пользователями
- `GET /team/get?team_name=...` - Получить информацию о команде
- `POST /team/deactivateMembers` - Массовая деактивация пользователей команды
- `POST /users/setIsActive` - Изменить статус активности пользователя
- `GET /users/getReview?user_id=...` - Получить список PR для ревью
- `POST /pullRequest/create` - Создать PR с автоматическим назначением ревьюверов
- `GET /pullRequest/get?pull_request_id=...` - Получить информацию о PR
- `POST /pullRequest/merge` - Смержить PR
- `POST /pullRequest/reassign` - Переназначить ревьювера
- `GET /statistics?team_name=...` - Получить статистику по назначениям
- `GET /health` - Проверка здоровья сервиса

Подробное описание всех эндпоинтов, запросов и ответов смотрите в `api/openapi.yml`.
## Архитектура

Проект следует принципам Clean Architecture:

- `cmd/` - точка входа приложения
- `internal/app/` - инициализация приложения и зависимостей
- `internal/domain/` - доменная логика (сущности, интерфейсы репозиториев)
- `internal/usecase/` - бизнес-логика (use cases)
- `internal/delivery/http/` - HTTP handlers, middleware, валидация
- `internal/infrastructure/` - реализации (PostgreSQL, конфигурация, логирование)

Принципы:

- Зависимости направлены внутрь (domain не зависит от infrastructure)
- Use cases содержат бизнес-логику и работают через интерфейсы
- Handlers занимаются только HTTP-специфичными задачами
- Валидация входных данных вынесена в отдельный пакет

## Тестирование

Проект включает три уровня тестирования:

1. Unit тесты - тестирование отдельных компонентов с моками
2. Интеграционные тесты - тестирование API с реальной БД через Docker
3. E2E тесты - полные сценарии работы сервиса

### Запуск тестов

Все тесты можно запустить через Makefile:

- `make test` - запустить unit тесты
- `make test-integration` - запустить интеграционные тесты (требуется Docker)
- `make test-e2e` - запустить E2E тесты (требуется Docker)

Для запуска интеграционных и E2E тестов требуется Docker. Тесты автоматически поднимают необходимые контейнеры, выполняют проверки и очищают окружение.

Моки генерируются с помощью `go.uber.org/mock`. Для генерации моков используйте команду `make mocks`.

## Нагрузочное тестирование

Нагрузочное тестирование выполняется с помощью K6. Скрипт находится в `loadtest/k6/k6_load_test.js`.

Профиль нагрузки соответствует требованиям ТЗ:
- RPS: 5 (стабильная нагрузка)
- SLI времени ответа: 300 мс
- SLI успешности: 99.9%

Тестовые данные:
- До 20 команд
- До 200 пользователей
- 10 PR для тестирования переназначения

Результаты нагрузочного тестирования:

```

         /\      Grafana   /‾‾/
    /\  /  \     |\  __   /  /
   /  \/    \    | |/ /  /   ‾‾\
  /          \   |   (  |  (‾)  |
 / __________ \  |_|\_\  \_____/

     execution: local                                                                                                                                                                                                              
        script: loadtest/k6/k6_load_test.js                                                                                                                                                                                        
        output: -                                                                                                                                                                                                                  

     scenarios: (100.00%) 1 scenario, 10 max VUs, 5m0s max duration (incl. graceful stop):                                                                                                                                         
              * default: Up to 10 looping VUs for 4m30s over 5 stages (gracefulRampDown: 30s, gracefulStop: 30s)

INFO[0000] Сервер готов                                  source=console
INFO[0000] Подготовка тестовых данных...                 source=console
INFO[0000] Подготовка завершена: команды=10, пользователей_на_команду=20, всего_пользователей=200, pr=10  source=console
INFO[0271] Очистка завершена                             source=console


  █ THRESHOLDS

    deactivate_team_duration_ms
    ✓ 'p(95)<300' p(95)=13                                                                                                                                                                                                         
    ✓ 'p(99.9)<300' p(99.9)=23.484                                                                                                                                                                                                 

    http_req_duration
    ✓ 'p(95)<300' p(95)=11.08ms                                                                                                                                                                                                    
    ✓ 'p(99.9)<300' p(99.9)=25.63ms                                                                                                                                                                                                

    http_req_failed{name:!ReassignReviewer}
    ✓ 'rate<0.001' rate=0.00%                                                                                                                                                                                                      

    real_errors
    ✓ 'rate<0.001' rate=0.00%                                                                                                                                                                                                      

    reassign_reviewer_duration_ms
    ✓ 'p(95)<300' p(95)=0                                                                                                                                                                                                          
    ✓ 'p(99.9)<300' p(99.9)=0                                                                                                                                                                                                      


  █ TOTAL RESULTS

    checks_total.......: 10551   38.932985/s
    checks_succeeded...: 100.00% 10551 out of 10551
    checks_failed......: 0.00%   0 out of 10551

    ✓ статус деактивации команды 200                                                                                                                                                                                               
    ✓ длительность деактивации команды < 300ms                                                                                                                                                                                     
    ✓ ответ деактивации команды содержит команду                                                                                                                                                                                   

    CUSTOM
    deactivate_team_duration_ms.....: avg=8.999716 min=3        med=9        max=27       p(90)=11       p(95)=13                                                                                                                  
    deactivate_team_success.........: 100.00% 3517 out of 3517
    real_errors.....................: 0.00%   0 out of 3517
    reassign_reviewer_duration_ms...: avg=0        min=0        med=0        max=0        p(90)=0        p(95)=0                                                                                                                   

    HTTP
    http_req_duration...............: avg=6.21ms   min=519.2µs  med=5.73ms   max=50.21ms  p(90)=9.93ms   p(95)=11.08ms                                                                                                             
      { expected_response:true }....: avg=8.81ms   min=2.79ms   med=8.66ms   max=50.21ms  p(90)=10.97ms  p(95)=12.33ms                                                                                                             
    http_req_failed.................: 49.53%  3517 out of 7100
      { name:!ReassignReviewer }....: 0.00%   0 out of 0
    http_reqs.......................: 7100    26.198862/s

    EXECUTION
    iteration_duration..............: avg=414.42ms min=407.01ms med=413.99ms max=441.45ms p(90)=417.87ms p(95)=419.79ms                                                                                                            
    iterations......................: 3517    12.977662/s
    vus.............................: 1       min=1            max=10
    vus_max.........................: 10      min=10           max=10

    NETWORK
    data_received...................: 7.9 MB  29 kB/s
    data_sent.......................: 1.1 MB  4.2 kB/s


running (4m31.0s), 00/10 VUs, 3517 complete and 0 interrupted iterations
default ✓ [======================================] 00/10 VUs  4m30s
```

**Итоги нагрузочного тестирования:**

- Все пороги SLI пройдены успешно
- Время ответа: p(95) = 11.08ms, p(99.9) = 25.63ms (целевой показатель: 300ms)
- Производительность деактивации: p(95) = 13ms, p(99.9) = 23.484ms (целевой показатель: 300ms)
- Процент ошибок: 0.00% (целевой показатель: < 0.1%, SLI успешности 99.9%)
- Все проверки пройдены: 10551/10551 (100%)
- Стабильная работа при нагрузке 5 RPS на протяжении 4.5 минут

Результаты соответствуют требованиям ТЗ по всем показателям производительности.

## Покрытие тестами

Для проверки покрытия тестами используется команда:

```bash
make coverage
```

Результаты покрытия тестами:

```
$ make coverage
ok      github.com/exPriceD/pr-reviewer-service/internal/delivery/http/handler  1.504s  coverage: 79.7% of statements
ok      github.com/exPriceD/pr-reviewer-service/internal/delivery/http/middleware       1.598s  coverage: 84.9% of statements
ok      github.com/exPriceD/pr-reviewer-service/internal/delivery/http/presenter        1.428s  coverage: 98.0% of statements
ok      github.com/exPriceD/pr-reviewer-service/internal/delivery/http/validator        1.471s  coverage: 80.4% of statements
ok      github.com/exPriceD/pr-reviewer-service/internal/domain/entity  1.207s  coverage: 96.5% of statements
ok      github.com/exPriceD/pr-reviewer-service/internal/usecase        1.217s  coverage: 72.1% of statements

total:          (statements)         80.8%
 ```

**Итоги покрытия тестами:**

- Общее покрытие: **80.8%**
- Handler слой: 79.7%
- Middleware: 84.9%
- Presenter: 98.0%
- Validator: 80.4%
- Domain entities: 96.5%
- Use cases: 72.1%

Покрытие тестами ключевых компонентов превышает целевой показатель 70%.

## Проблемы и решения

### Оптимизация массовой деактивации пользователей

Изначально массовая деактивация выполнялась через N отдельных UPDATE запросов (по одному на каждого пользователя), что приводило к N+1 проблеме и не укладывалось в требования по производительности.

Решение: реализован batch UPDATE на уровне репозитория - один запрос обновляет всех активных пользователей команды:

```sql
UPDATE users SET is_active = FALSE WHERE team_name = $1 AND is_active = TRUE
```

Это позволило уложиться в целевые 100 мс даже для команд с большим количеством пользователей.

### Оптимизация переназначения ревьювера

Первоначальная реализация переназначения включала три операции: обновление PR, удаление всех reviewers и вставка новых. Это было избыточно для замены одного ревьювера.

Решение: реализован специальный метод `ReplaceReviewer`, который выполняет один UPDATE запрос:

```sql
UPDATE pr_reviewers SET user_id = $3 
WHERE pull_request_id = $1 AND user_id = $2
```

Это значительно улучшило производительность операции переназначения.

### Обработка 409 NO_CANDIDATE в нагрузочном тестировании

При нагрузочном тестировании обнаружилось, что после деактивации всех пользователей команды, переназначение ревьювера возвращает 409 NO_CANDIDATE, что является валидным поведением API (нет активных кандидатов для замены), но K6 считает 4xx статусы ошибками.

Решение: добавлена кастомная метрика `real_errors`, которая исключает 409 NO_CANDIDATE для ReassignReviewer из ошибок, так как это ожидаемое поведение API при отсутствии активных кандидатов.

### Конфигурация через переменные окружения

Требовалось обеспечить гибкую настройку для разных окружений (разработка, Docker, E2E тесты) без изменения кода.

Решение: реализована система конфигурации с приоритетом переменных окружения над значениями из YAML файлов. Это позволяет легко настраивать окружение для Docker и CI/CD без изменения конфигурационных файлов.

## Вопросы и их решение

### Несоответствие в OpenAPI спецификации

При реализации эндпоинта `/pullRequest/reassign` обнаружилось несоответствие в OpenAPI спецификации:

```yaml
required: [ pull_request_id, old_user_id ]
properties:
  pull_request_id: { type: string }
  old_user_id: { type: string }
example:
  pull_request_id: pr-1001
  old_reviewer_id: u2
```

В секции `required` и `properties` указано поле `old_user_id`, но в `example` используется `old_reviewer_id`. 

Решение: было принято решение использовать `old_user_id` везде в коде и API, так как это соответствует названию поля в схеме. В примерах также используется `old_user_id`.

### Вопросы по бизнес-логике

В процессе разработки возникли вопросы, на которые были приняты следующие решения:

#### 1. Что происходит, если создают команду, в которой есть пользователь, который был до этого в другой команде?

Ответ: Пользователь переносится в новую команду. При создании команды через `/team/add` система обновляет `team_name` у существующих пользователей, если они указаны в списке членов новой команды. Это означает, что пользователь может находиться только в одной команде в каждый момент времени, и добавление его в новую команду автоматически удаляет его из предыдущей.

#### 2. Что происходит с PR, если его автора удаляют или деактивируют?

Ответ: На операции с PR деактивация автора не влияет. PR остаются без изменений. Деактивация или удаление автора не приводит к удалению или изменению статуса PR. Это логично, так как PR уже создан и имеет свою историю. Для предотвращения удаления авторов с активными PR используется ограничение на уровне базы данных (`ON DELETE RESTRICT`).

#### 3. Может ли пользователь состоять в нескольких командах?

Ответ: Нет, пользователь может быть только в одной команде одновременно. Это обеспечивается на уровне базы данных - поле `team_name` в таблице `users` не является частью первичного ключа, но логика приложения гарантирует, что при добавлении пользователя в новую команду он автоматически удаляется из предыдущей. Фактически, `user_id` является уникальным идентификатором пользователя, и один пользователь может быть связан только с одной командой.

## Дополнительные возможности

Реализованы все дополнительные задания из ТЗ:

- Эндпоинт статистики (`GET /statistics`) с возможностью получения статистики по команде
- Метод массовой деактивации пользователей команды (`POST /team/deactivateMembers`)
- Оптимизация производительности для операций деактивации и переназначения
- Интеграционные и E2E тесты
- Конфигурация golangci-lint (`golangci.yml`)
